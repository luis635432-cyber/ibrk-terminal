<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOTS ELITE TERMINAL</title>
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background: #000; color: #fff; font-family: 'JetBrains Mono', monospace; -webkit-font-smoothing: antialiased; }
        .card { background: rgba(12, 12, 12, 0.9); border: 1px solid #1a1a1a; border-radius: 20px; padding: 18px; margin-bottom: 12px; position: relative; overflow: hidden; }
        .up { color: #00ff88; }
        .down { color: #ff3b3b; }
        .header-glass { background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); border-bottom: 1px solid #1a1a1a; }
        .weight-bar { position: absolute; bottom: 0; left: 0; height: 3px; background: #3b82f6; }
        .filter-btn { font-size: 10px; font-weight: 800; padding: 6px 16px; border-radius: 12px; border: 1px solid #1a1a1a; color: #52525b; transition: all 0.2s; }
        .filter-btn.active { background: #fff; color: #000; border-color: #fff; }
        .blur-val { transition: filter 0.3s ease; }
        body.is-private .blur-val { filter: blur(7px); pointer-events: none; }
        .health-bg { background: #111; height: 4px; width: 100%; border-radius: 2px; margin-top: 8px; overflow: hidden; }
        .health-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #00ff88); transition: width 1s ease; }
        .badge-free { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .badge-stop { font-size: 11px; padding: 4px 10px; border-radius: 6px; font-weight: bold; border: 1px solid; text-transform: uppercase; }
        .mkt-status { font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
    </style>
</head>
<body class="pb-10">

    <div class="header-glass sticky top-0 z-50 p-6 mb-2">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <p class="text-[8px] text-zinc-500 tracking-[0.2em] uppercase mb-1">Dots Elite System <span id="sync-clock" class="text-white font-bold ml-2">--:--</span></p>
                    <div class="flex items-baseline gap-2">
                        <h1 id="nav" class="text-3xl font-bold tracking-tighter">---</h1>
                        <span id="roi" class="text-sm font-bold up">---</span>
                    </div>
                </div>
                <button onclick="togglePrivacy()" class="p-3 bg-zinc-900 rounded-2xl border border-zinc-800 active:scale-90 transition-all">
                    <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-zinc-500"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>
            
            <div class="flex justify-between items-end mb-6">
                <div class="w-full mr-12">
                    <p class="text-[8px] text-zinc-500 tracking-widest uppercase">Security Score</p>
                    <div class="health-bg"><div id="health-bar" class="health-fill" style="width: 0%"></div></div>
                </div>
                <div class="text-right whitespace-nowrap">
                    <p class="text-[8px] text-zinc-500 tracking-widest uppercase">P&L Open</p>
                    <h1 id="totalPnL" class="text-2xl font-bold blur-val">---</h1>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="setFilter('ALL')" id="btn-ALL" class="filter-btn active">ALL</button>
                <button onclick="setFilter('RISK')" id="btn-RISK" class="filter-btn">RISK</button>
                <button onclick="setFilter('FREE')" id="btn-FREE" class="filter-btn">FREE</button>
            </div>
        </div>
    </div>

    <div class="max-w-md mx-auto px-4 mt-4"><div id="grid" class="space-y-1"></div></div>

    <script>
        // URL de tu Apps Script Actualizada
        const API_URL = "https://script.google.com/macros/s/AKfycbySVTBHw-NBoN7m_7P-aQroeeahMXqpg4VSMW7hUDtDEbOC7KkmfGvFsUKOtZqyC9Gz/exec";
        let currentData = null;
        let activeFilter = 'ALL';

        function togglePrivacy() {
            document.body.classList.toggle('is-private');
            const icon = document.getElementById('eye-icon');
            const isPrivate = document.body.classList.contains('is-private');
            icon.style.color = isPrivate ? '#00ff88' : '#52525b';
        }

        function setFilter(f) {
            activeFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${f}`).classList.add('active');
            if(currentData) renderGrid(currentData);
        }

        function getMarketStatus() {
            const hour = new Date().getHours() + new Date().getMinutes()/60;
            if (hour >= 10 && hour < 15.5) return { label: 'PRE', color: 'bg-orange-500/20 text-orange-500' };
            if (hour >= 15.5 && hour < 22) return { label: 'LIVE', color: 'bg-green-500/20 text-green-500' };
            if (hour >= 22 || hour < 2) return { label: 'AFT', color: 'bg-blue-500/20 text-blue-500' };
            return { label: 'CLOSED', color: 'bg-zinc-800 text-zinc-500' };
        }

        async function refresh() {
            try {
                const res = await fetch(API_URL);
                currentData = await res.json();
                renderGrid(currentData);
            } catch (e) { console.error("Error en API:", e); }
        }

        function renderGrid(data) {
            const mkt = getMarketStatus();
            document.getElementById('sync-clock').innerText = new Date().toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
            document.getElementById('nav').innerText = data.nav;
            document.getElementById('roi').innerText = `+${data.roi}%`;
            
            const tpnl = parseFloat(data.totalPnLCash);
            const pnlEl = document.getElementById('totalPnL');
            pnlEl.innerText = (tpnl >= 0 ? '+$' : '-$') + Math.abs(tpnl).toLocaleString(undefined, {minimumFractionDigits: 2});
            pnlEl.className = `text-2xl font-bold blur-val ${tpnl >= 0 ? 'up' : 'down'}`;

            const freeCount = data.activos.filter(a => a.isFreeRoll).length;
            document.getElementById('health-bar').style.width = `${(freeCount / data.activos.length) * 100}%`;

            const grid = document.getElementById('grid');
            grid.innerHTML = "";

            const filtered = data.activos.filter(a => {
                if(activeFilter === 'RISK') return !a.isFreeRoll;
                if(activeFilter === 'FREE') return a.isFreeRoll;
                return true;
            });

            filtered.forEach(a => {
                const totalUp = parseFloat(a.pnlCash) >= 0;
                const dailyUp = parseFloat(a.dailyChange) >= 0;
                const weight = ((parseFloat(a.currentPrice) * parseFloat(a.qty)) / (parseFloat(data.nav) * 100)).toFixed(1);
                
                const card = document.createElement('div');
                card.className = "card shadow-2xl";
                card.innerHTML = `
                    <div class="weight-bar" style="width: ${weight * 5}%"></div>
                    <div class="flex justify-between items-start relative z-10">
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <h3 class="text-xl font-bold tracking-tight">${a.ticker}</h3>
                                ${a.isFreeRoll ? `<span class="badge-free">üõ°Ô∏è FREE ROLL</span>` : ''}
                            </div>
                            <div class="flex flex-col gap-0.5">
                                <span class="text-[13px] font-bold ${totalUp ? 'up' : 'down'} blur-val uppercase">P&L: ${totalUp ? '+' : '-'}$${Math.abs(a.pnlCash)}</span>
                                <span class="text-[10px] text-zinc-500 font-bold blur-val uppercase tracking-tighter">INVERTIDO: $${(a.qty * a.entry).toFixed(0)}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold tracking-tighter flex items-center justify-end">
                                $${a.currentPrice}
                                <span class="text-[12px] ${dailyUp ? 'up' : 'down'} ml-1.5 font-bold">${dailyUp ? '+' : ''}${a.dailyChange}%</span>
                                <span class="mkt-status ${mkt.color}">${mkt.label}</span>
                            </div>
                            <div class="text-[12px] font-bold ${totalUp ? 'up' : 'down'} mt-1 tracking-tighter">TOTAL: ${a.pnlPercent}%</div>
                        </div>
                    </div>
                    ${a.stopDist ? `
                    <div class="mt-5 pt-4 border-t border-white/5 flex justify-between items-end">
                        <div class="flex items-center gap-3">
                            <span class="badge-stop ${parseFloat(a.stopDist) < 3 ? 'down animate-pulse' : 'up'}" style="background: rgba(0,0,0,0.4); border-color: currentColor;">
                                üõ°Ô∏è STOP: ${a.stopDist}%
                            </span>
                            <div class="flex flex-col">
                                <span class="text-[8px] text-zinc-600 uppercase font-bold tracking-widest">Initial Risk</span>
                                <span class="text-[12px] font-bold text-zinc-300 blur-val">-$${Math.abs(a.riskCash)}</span>
                            </div>
                        </div>
                        <span class="text-[9px] text-zinc-700 font-bold mb-0.5">UNITS: ${a.qty}</span>
                    </div>` : ''}
                `;
                grid.appendChild(card);
            });
        }
        refresh();
        setInterval(refresh, 30000);
    </script>
</body>
</html>
